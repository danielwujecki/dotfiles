#!/usr/bin/busybox ash

ascii_logo() {
    LOGO="H4sIAAAAAAAAA5VRy47DIAy88xVWOWRVlZ1bb5W6ym9YQuljpUhNIzXtjY/fGJYYdpVDHSDYY88Y
          MLQY2Oh+u1Vvdma3ykD6cZkISVhAVtq8gsuI4vIpOeLgQiOHJVHWhKY9Z2oQKKNGeWLkV7Bsjgs0
          syt3zo5M0Fay5N/2sBAb7xFHNKTJPs03zeh7iPnDzheR0WNPsMWj0axBwVrQql26e3+9NRP19/75
          6IbvqdQ4NME5Xi0mcv+sblGUbeM+V8qPX6fu/Jro2I7DMF7Gx7UuZxu8HFQYUEMUMB/vgyyFDdVQ
          C9o5JzdtzA8nM11ezwIAAA=="

    echo "$LOGO" | sed 's/ //g' | base64 -d | gzip -d | cat
}

launch_shell() {
    export PS1='[busybox \W]\$ '
    [ "$1" = "--exec" ] && exec setsid cttyhack ash -i
    setsid cttyhack ash -i
}

cmdline() {
    local value
    value=" $(cat /proc/cmdline) "
    value="${value##* ${1}=}"
    value="${value%% *}"
    [ -n "$value" ] && echo "$value"
}

/usr/bin/busybox --install -s
ascii_logo

mount -t proc     proc /proc -o nosuid,noexec,nodev
mount -t sysfs    sys  /sys  -o nosuid,noexec,nodev
mount -t devtmpfs dev  /dev  -o nosuid,mode=0755
mount -t tmpfs    run  /run  -o nosuid,nodev,mode=0755

cryptdevice_uuid="$(cmdline 'rd.luks.uuid')"
if [ -n "$cryptdevice_uuid" ] ; then
    cryptdevice="$(findfs "UUID=$cryptdevice_uuid")"
    [ -b "$cryptdevice" ] || launch_shell --exec
    mkdir -p /run/cryptsetup

    allowdiscards="$(cmdline 'rd.luks.allow-discards')"
    if [ -n "allowdiscards" ] ; then
        cryptsetup luksOpen --allow-discards "$cryptdevice" "root_crypt" || launch_shell --exec
    else
        cryptsetup luksOpen "$cryptdevice" "root_crypt" || launch_shell --exec
    fi
fi

lvm_vg="$(cmdline 'rd.lvm.vg')"
if [ -n "$lvm_vg" ] ; then
    lvm vgchange -aly "$lvm_vg"
    lvm vgscan --mknodes
fi

resume="$(cmdline 'resume')"
[ -z "$resume" ] || resumedev="$(findfs "$resume")"
if [ -e /sys/power/resume -a -b "$resumedev" ] ; then
    printf "%d:%d" $(stat -Lc "0x%t 0x%T" "$resumedev") > /sys/power/resume
fi

rootdevice_cmd="$(cmdline 'root')"
rootdevice="$(findfs "$rootdevice_cmd")"
[ -b "$rootdevice" -o -h "$rootdevice" ] || launch_shell --exec

fstype="$(cmdline 'rootfstype')"
[ -n "$fstype" ] || fstype="auto"
rflags="$(cmdline 'rootflags')"
[ -n "$rflags" ] || rflags="ro,noatime"
mount -t "$fstype" -o "$rflags" "$rootdevice" /mnt || launch_shell --exec

rdbreak="$(cmdline 'rd.break')"
[ -z "$rdbreak" ] || launch_shell

umount /proc
umount /sys
umount /dev
umount /run

exec switch_root /mnt /sbin/init

# vim: set ft=sh ts=4 sw=4 et:
