#!/usr/bin/env bash
set -euo pipefail

SYNCLIST="$HOME/.config/rclone/synclist.txt"

YELLOW='\e[33m'
WHITE='\e[0m'

SYNC_UP=
SYNC_DOWN=
#RCLONE_FLAGS=(-i)
RCLONE_FLAGS=(-P)

usage() {
    #echo "usage: gdrive up|down [--fast]"
    echo "usage: gdrive up|down"
}

if [[ ! -f $SYNCLIST ]] ; then
    echo "Synclist not found: $SYNCLIST"
    exit 1
fi

while [[ $# -gt 0 ]] ; do
    case "$1" in
        up)
            if [[ -n $SYNC_DOWN ]] ; then
                echo "Already specified 'down'."
                usage
                exit 1
            fi
            SYNC_UP=1
            shift
            ;;
        down)
            if [[ -n $SYNC_UP ]] ; then
                echo "Already specified 'up'."
                usage
                exit 1
            fi
            SYNC_DOWN=1
            shift
            ;;
        #--fast)
        #    RCLONE_FLAGS=(-P)
        #    shift
        #    ;;
        *)
            echo "Invalid argument: '$1'"
            usage
            exit 1
            ;;
    esac
done

echo -e "${YELLOW}Using synclist: '$SYNCLIST'${WHITE}"

cd "$HOME"
while read -r SRC DST ; do
    [[ -n $SRC ]] || continue
    if [[ ! -e $SRC ]] || grep -ivq '\S\+:' <<< "$DST" ; then
        echo "Synclist faulty entry."
        exit 1
    fi

    if [[ -n $SYNC_UP ]] ; then
        echo -e "${YELLOW}Syncing '$SRC' to '$DST'.${WHITE}"
        rclone sync "${RCLONE_FLAGS[@]}" "$SRC" "$DST"
    elif [[ -n $SYNC_DOWN ]] ; then
        echo -e "${YELLOW}Syncing '$DST' to '$SRC'.${WHITE}"
        rclone sync "${RCLONE_FLAGS[@]}" "$DST" "$SRC"
    else
        echo "Neither specified 'up' or 'down'."
        usage
        exit 1
    fi
done <<< "$(egrep -v '^\s*#' "$SYNCLIST")"
