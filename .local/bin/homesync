#!/usr/bin/env bash
set -euo pipefail

SYNCLIST=(
    "$HOME/Backups"
    "$HOME/Bilder"
    "$HOME/Dokumente"
    "$HOME/Downloads"
    "$HOME/Musik"
    "$HOME/Repositories"
    "$HOME/Studium"
)

HOSTNAME_SRC="daniel@commodore.fritz.box"
HOSTNAME_DEST="daniel@abacus.fritz.box"
RSYNC_FLAGS=(-uahbHP --exclude=build/ --delete --backup-dir=/home/daniel/rsync_backup --rsh="ssh -p 22")
# "-u": überspringe Dateien, die im Ziel neuer sind
# "-a": archive mode
# "-h": human readable
# "-b": sicherung von gelöschten / veränderten daten in backup dir
# "-H": hardlinks werden berücksichtigt
# "-P": --partial --progress (einfach weiter machen)

# "--delete": dateien, die im quellverzeichnis gelöscht wurden, werden
#             auch im zielverzeichnis gelöscht

# "--backup-dir": Ort and dem gelöschte / veränderte Daten gesichert werden

# "--rsh": ssh konfiguration für die Verbindung

YELLOW='\e[33m'
WHITE='\e[0m'

usage() {
    echo "usage: homesync up|down|push|pull"
}

if [[ $# -ne 1 ]] ; then
    usage
    exit 1
fi

for DIREC in "${SYNCLIST[@]}" ; do
    if [[ ! -e $DIREC ]] || grep -ivq "^$HOME/\w\+$" <<< "$DIREC" ; then
        echo -e "${YELLOW}Synclist faulty entry:${WHITE} $DIREC"
        exit 1
    fi

    case "$1" in
        up)
            echo -e "${YELLOW}Syncing${WHITE} $DIREC ${YELLOW}to${WHITE} $HOSTNAME_DEST${YELLOW}.${WHITE}"
            rsync "${RSYNC_FLAGS[@]}" "$DIREC" "$HOSTNAME_DEST:$HOME"
            ;;
        down)
            echo -e "${YELLOW}Syncing${WHITE} $HOSTNAME_DEST:$DIREC ${YELLOW}to${WHITE} localhost${YELLOW}.${WHITE}"
            rsync "${RSYNC_FLAGS[@]}" "$HOSTNAME_DEST:$DIREC" "$HOME"
            ;;
        push)
            echo -e "${YELLOW}Syncing${WHITE} $DIREC ${YELLOW}to${WHITE} $HOSTNAME_SRC${YELLOW}.${WHITE}"
            rsync "${RSYNC_FLAGS[@]}" "$DIREC" "$HOSTNAME_SRC:$HOME"
            ;;
        pull)
            echo -e "${YELLOW}Syncing${WHITE} $HOSTNAME_SRC:$DIREC ${YELLOW}to${WHITE} localhost${YELLOW}.${WHITE}"
            rsync "${RSYNC_FLAGS[@]}" "$HOSTNAME_SRC:$DIREC" "$HOME"
            ;;
        *)
            echo "Invalid argument: '$1'"
            usage
            exit 1
            ;;
    esac
done
